#!/usr/bin/env ruby

require 'fileutils'
$stdout.sync = true

#
# Setting up directories
#
BUILDPACK_DIR = File.absolute_path(File.dirname($0) + '/..')
BUILD_DIR, CACHE_DIR = ARGV.map { |p| File.absolute_path(p) }
FileUtils.mkdir_p([BUILD_DIR, CACHE_DIR, "#{CACHE_DIR}/.dub"])
if !File.exist?("#{BUILD_DIR}/.dub")
  FileUtils.ln_s("#{CACHE_DIR}/.dub", "#{BUILD_DIR}/.dub")
end

#
# Utility methods
#
def puts_caption(s)
  puts "\n-----> #{s}"
end
def puts_indent(s)
  puts "       #{s}"
end

def read_config_file(dir)
  content = File.read("#{dir}/vibed_buildpack.config") rescue ''
  kvs = content.split("\n").map { |line| line.split('=').map(&:strip) }.select { |pair| pair.size == 2 }
  Hash[kvs]
end

def ensure_archive(url)
  basename = File.basename(url)
  tool_name = basename[0..2]
  path = "#{CACHE_DIR}/#{basename}"
  if !File.exist?(path)
    FileUtils.rm_f(Dir["#{tool_name}*"])
    puts_caption "Downloading #{tool_name} from #{url}..."
    puts_indent `curl -L "#{url}" -o #{path}`
    fail "Failed to retrieve an archive from #{url}!" unless $?.success?
  end
  path
end

def extract_archive(path)
  puts_caption "Extracting #{path}..."
  if path.end_with?('.zip')
    puts_indent `unzip -o -d #{CACHE_DIR} #{path}`
  elsif path.end_with?('.tar.gz') || path.end_with?('.tgz')
    puts_indent `tar -xzf #{path} --directory=#{CACHE_DIR}`
  else
    fail 'Unexpected archive format!'
  end
  fail "Failed to extract archive #{path}!" unless $?.success?
end

#
# Start
#
CONFIG_DICT = read_config_file(BUILDPACK_DIR).merge read_config_file(BUILD_DIR)
puts_caption 'Config:'
CONFIG_DICT.each { |k, v| puts_indent "#{k}=#{v}" }

DMD_BIN_DIR_PATH = "#{CACHE_DIR}/dmd2/linux/bin64"
if !File.exist?("#{DMD_BIN_DIR_PATH}/dmd")
  DMD_ARCHIVE_PATH = ensure_archive(CONFIG_DICT['DMD_ARCHIVE_URL'])
  extract_archive(DMD_ARCHIVE_PATH)
end

DUB_BIN_PATH = "#{CACHE_DIR}/dub"
if !File.exist?(DUB_BIN_PATH)
  DUB_ARCHIVE_PATH = ensure_archive(CONFIG_DICT['DUB_ARCHIVE_URL'])
  extract_archive(DUB_ARCHIVE_PATH)
end

puts_caption 'Building app...'
Dir.chdir(BUILD_DIR) do
  puts_indent `PATH=$PATH:#{DMD_BIN_DIR_PATH} #{DUB_BIN_PATH} build --build=release`
  FileUtils.rm_rf(%w(source src views))
  fail 'Build failed!' unless $?.success?
end
